name: Update Preview Index

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  update-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Generate preview index
        run: |
          mkdir -p previews
          cat > previews/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Documentation Previews</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                  }
                  h1 { color: #333; }
                  ul { list-style: none; padding: 0; }
                  li {
                      padding: 15px;
                      margin: 10px 0;
                      background: #f5f5f5;
                      border-radius: 5px;
                  }
                  a {
                      color: #0366d6;
                      text-decoration: none;
                      font-weight: 500;
                  }
                  a:hover { text-decoration: underline; }
              </style>
          </head>
          <body>
              <h1>ðŸ“š Active Documentation Previews</h1>
              <ul>
          EOF

          # List all PR preview directories
          for dir in pr-*/; do
              if [ -d "$dir" ]; then
                  pr_num=${dir#pr-}
                  pr_num=${pr_num%/}
                  echo "<li><a href=\"$dir\">PR #$pr_num Preview</a></li>" >> previews/index.html
              fi
          done

          cat >> previews/index.html << 'EOF'
              </ul>
          </body>
          </html>
          EOF

          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add previews/index.html
          git diff --staged --quiet || git commit -m "Update preview index"
          git push
